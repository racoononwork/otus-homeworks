name: C++ CI / Documentation Deployment

on:
  push:
    branches: [ main, 'feature/**' ]
  workflow_dispatch:

permissions:
  contents: write
  pages: write
  id-token: write

concurrency:
  group: "pages"
  cancel-in-progress: false

jobs:
  # This job triggers the reusable workflow for each project
  build-all-projects:
    strategy:
      fail-fast: false
      matrix:
        project:
          - dir: hw-1-helloworld
            name: helloworld
            extra-deps: ""
            needs-capnp: false
            run-tests: true
          - dir: hw-2-ip-filter
            name: ip-filter
            extra-deps: ""
            needs-capnp: false
            run-tests: true
          - dir: hw-3-custom-allocator
            name: custom-allocator
            extra-deps: ""
            needs-capnp: false
            run-tests: true
          - dir: hw-4-doxygen
            name: doxygen
            extra-deps: "doxygen graphviz"
            needs-capnp: false
            run-tests: false   # No tests likely
          - dir: hw-5-editor
            name: editor
            extra-deps: "build-essential cmake pkg-config libfontconfig1-dev libxcb-shape0-dev libxcb-xfixes0-dev libxkbcommon-dev libasound2-dev build-essential cmake pkg-config libfontconfig1-dev libxcb-shape0-dev libxcb-xfixes0-dev libxkbcommon-dev libasound2-dev curl"
            needs-capnp: true
            run-tests: true
          - dir: hw-6-matrix
            name: matrix
            extra-deps: ""
            needs-capnp: false
            run-tests: true
          - dir: hw-7-bulk
            name: bulk
            extra-deps: ""
            needs-capnp: false
            run-tests: true
          - dir: hw-8-boost
            name: boost
            extra-deps: "libboost-all-dev"
            needs-capnp: false
            run-tests: true
          - dir: hw-9-async
            name: async
            extra-deps: ""
            needs-capnp: false
            run-tests: true
          - dir: hw-10-bulk
            name: bulk-server
            extra-deps: ""
            needs-capnp: false
            run-tests: true
          - dir: hw-11-join
            name: join-server
            extra-deps: ""
            needs-capnp: false
            run-tests: true
          - dir: hw-12-mapreduce
            name: mapreduce
            extra-deps: ""
            needs-capnp: false
            run-tests: true
          - dir: hw-13-ML
            name: fashion-mnist
            extra-deps: "libeigen3-dev libboost-all-dev libspdlog-dev"
            needs-capnp: false
            run-tests: true
    uses: ./.github/workflows/project-ci.yml
    with:
      project-dir: ${{ matrix.project.dir }}
      project-name: ${{ matrix.project.name }}
      extra-deps: ${{ matrix.project.extra-deps }}
      needs-capnp: ${{ matrix.project.needs-capnp }}
      run-tests: ${{ matrix.project.run-tests }}
    secrets: inherit   # Passes GITHUB_TOKEN automatically

  # Documentation job remains separate
  build_docs:
    runs-on: ubuntu-latest
    if: github.ref == 'refs/heads/main'
    steps:
      - uses: actions/checkout@v4
      - name: Install Doxygen
        run: sudo apt-get update && sudo apt-get install -y doxygen graphviz
      - name: Generate docs
        run: cd hw-4-doxygen && doxygen Doxyfile && cp -r docs ../  # Make sure Doxyfile exists in root
      - name: Upload Pages artifact
        uses: actions/upload-pages-artifact@v3
        with:
          path: ./docs/html

  deploy_docs:
    needs: build_docs
    if: github.ref == 'refs/heads/main'
    environment:
      name: github-pages
      url: ${{ steps.deployment.outputs.page_url }}
    runs-on: ubuntu-latest
    steps:
      - name: Deploy to GitHub Pages
        id: deployment
        uses: actions/deploy-pages@v4
